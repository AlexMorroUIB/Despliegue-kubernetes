name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint yaml files
    steps:
      - uses: actions/checkout@v4
      - name: K8s Lint
        uses: azure/k8s-lint@v3
        with:
          manifests: k8s/

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v2
      - uses: docker/build-push-action@v4
        with:
          context: ./WebApp/
          file: "Dockerfile"
          tags: webapp:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: false
      - name: Run webapp
        uses: addnab/docker-run-action@v3
        with:
          image: webapp:latest
          run: echo "curl http://localhost/health"

  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: test
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v4
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: workspace_artifacts
          path: ${{ github.workspace }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy echo
        run: |
          cat <<EOF
          Para integrar la nueva versión en k8s deberías ejecutar los siguientes comandos:
          cd WebApp
          minikube image rm webapp:latest
          minikube image build -t webapp:latest .
          cd ../k8s
          kubectl delete -n webapp-ns deployment webapp-deployment
          kubectl apply -f ./webapp/web-deployment.yaml
          EOF